name: CD Python - DÃ©ploiement Windows

on:
  push:
    branches: [ main, master ]

env:
  PYTHON_VERSION: '3.11'
  PROJECT_NAME: 'python-task-manager'
  DEPLOY_PORT: '8000'

jobs:
  test:
    name: 'Tests et Validation'
    runs-on: ubuntu-latest
    
    steps:
    - name: 'ðŸ“¥ Checkout du code'
      uses: actions/checkout@v4
    
    - name: 'Configuration Python'
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: 'Installation des dÃ©pendances'
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov
    
    - name: 'ExÃ©cution des tests'
      run: |
        echo "Lancement des tests Python..."
        python -m pytest tests/ -v --cov=app --cov-report=xml
        
        echo "=== Structure des fichiers ==="
        find . -name "*.py" | head -10
        
        echo "=== Contenu du dossier app ==="
        ls -la app/
    
    - name: 'Upload rapport de couverture'
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests

  deploy:
    name: 'DÃ©ploiement Production'
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: 'Checkout du code'
      uses: actions/checkout@v4
    
    - name: 'Configuration Python'
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: 'Installation des dÃ©pendances'
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: 'Construction du package de dÃ©ploiement'
      run: |
        echo "=== Construction du package de dÃ©ploiement ==="
        
        # CrÃ©er un dossier de dÃ©ploiement propre
        mkdir -p deployment-package/app
        mkdir -p deployment-package/tests
        mkdir -p deployment-package/deploy
        
        # Copier les fichiers essentiels
        cp -r app/*.py deployment-package/app/
        cp -r app/templates/ deployment-package/app/
        cp -r tests/ deployment-package/ || echo "Aucun test Ã  copier"
        cp -r deploy/ deployment-package/ || echo "Aucun script deploy Ã  copier"
        cp requirements.txt runtime.txt config.py run.py deployment-package/
        
        # VÃ©rifier le contenu du package
        echo "=== Contenu du package ==="
        find deployment-package/ -type f | head -20
        
        echo "Package de dÃ©ploiement crÃ©Ã©"

    - name: 'Transfert des fichiers vers le serveur'
      uses: appleboy/scp-action@v0.1.3
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.DEPLOY_KEY }}
        source: "deployment-package/*"
        target: "C:\\apps\\${{ env.PROJECT_NAME }}-staging"
        strip_components: 1

    - name: 'ExÃ©cution du dÃ©ploiement'
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.DEPLOY_KEY }}
        script_stop: true
        script: |
          echo "=== DÃ‰BUT DU DÃ‰PLOIEMENT ==="
          set -e
          
          # Variables
          STAGING="C:/apps/${{ env.PROJECT_NAME }}-staging"
          LIVE="C:/apps/${{ env.PROJECT_NAME }}-live"
          BACKUP="C:/apps/${{ env.PROJECT_NAME }}-backup"
          PORT="${{ env.DEPLOY_PORT }}"
          
          # VÃ©rifier que les fichiers sont prÃ©sents
          echo "1. VÃ©rification des fichiers..."
          ls -la "$STAGING" || exit 1
          
          # Sauvegarder l'ancienne version si elle existe
          echo "2. Sauvegarde..."
          if [ -d "$LIVE" ]; then
            echo "â†’ ArrÃªt de l'application existante..."
            taskkill //F //IM python.exe 2>/dev/null || true
            sleep 2
            
            echo "â†’ CrÃ©ation de la sauvegarde..."
            BACKUP_NAME="backup_$(date +%Y%m%d_%H%M%S)"
            cp -r "$LIVE" "$BACKUP/$BACKUP_NAME" || exit 1
            rm -rf "$LIVE" || exit 1
            echo "SauvegardÃ©: $BACKUP_NAME"
          fi
          
          # DÃ©ployer la nouvelle version
          echo "3. DÃ©ploiement..."
          mv "$STAGING" "$LIVE" || exit 1
          echo "Nouvelle version dÃ©ployÃ©e"
          
          # Installation des dÃ©pendances
          echo "4. Installation des dÃ©pendances..."
          cd "$LIVE"
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          echo "DÃ©pendances installÃ©es"
          
          # DÃ©marrer l'application
          echo "5. DÃ©marrage de l'application..."
          # ArrÃªter tout processus Python existant
          taskkill //F //IM python.exe 2>/dev/null || true
          sleep 2
          
          # DÃ©marrer avec Waitress
          start //B python -m waitress --port=$PORT --call "run:main"
          echo "Application dÃ©marrÃ©e"
          
          # VÃ©rification
          echo "6. VÃ©rification..."
          sleep 10
          
          echo "â†’ VÃ©rification des processus..."
          tasklist //FI "IMAGENAME eq python.exe"
          
          echo "â†’ Test de santÃ©..."
          curl -f http://localhost:$PORT/health || echo "Health check a Ã©chouÃ©, mais l'application peut Ãªtre en cours de dÃ©marrage"
          
          echo "DÃ‰PLOIEMENT TERMINÃ‰ AVEC SUCCÃˆS"

    - name: 'VÃ©rification finale'
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.DEPLOY_KEY }}
        script: |
          echo "=== VÃ‰RIFICATION FINALE ==="
          echo "â†’ Processus Python en cours :"
          tasklist //FI "IMAGENAME eq python.exe"
          
          echo "â†’ Dossiers d'application :"
          ls -la "C:/apps/"
          
          echo "â†’ Test de connexion :"
          timeout 30 bash -c 'until curl -f http://localhost:${{ env.DEPLOY_PORT }}/health; do sleep 2; done' || echo "L'application met du temps Ã  rÃ©pondre"
          
          echo "VÃ©rification terminÃ©e"